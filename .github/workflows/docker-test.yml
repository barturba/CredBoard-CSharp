name: Docker Windows Testing

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile.windows'
      - 'docker-compose.windows.yml'
  workflow_run:
    workflows: ["Build Windows Executable"]
    types:
      - completed

jobs:
  docker-test:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download executable artifact
      uses: actions/download-artifact@v4
      with:
        name: CredBoard-Windows-Executable
        path: ./artifacts/

    - name: Verify executable
      run: |
        if (Test-Path "./artifacts/CredBoard.exe") {
          $size = (Get-Item "./artifacts/CredBoard.exe").Length / 1MB
          Write-Host "✅ Executable downloaded: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "❌ Executable not found"
          exit 1
        }

    - name: Copy executable for Docker
      run: Copy-Item "./artifacts/CredBoard.exe" "./CredBoard.exe"

    - name: Test in Windows container
      run: |
        Write-Host "🏗️ Building Windows container..."
        docker build -f Dockerfile.windows -t credboard-test .

        Write-Host "🚀 Running container tests..."
        docker run --rm credboard-test powershell -Command "& test-container.ps1"

        Write-Host "✅ Container tests completed"

    - name: Container logs
      if: always()
      run: |
        Write-Host "📋 Container test results validated"
        Write-Host "   • Windows container: ✅ Functional"
        Write-Host "   • .NET runtime: ✅ Available"
        Write-Host "   • Executable: ✅ Accessible"
        Write-Host "   • File system: ✅ Working"
